FROM debian:trixie
# Install Packer 1.9.5, it is the latest version with MPL licence
# Hardcode the current SHA256 checksum of the Packer binary to ensure we are
# using the correct version of Packer
ADD --checksum=sha256:6f8272658a6d606583c2b3deaad272233db6e84a6ee651bf17a0d46d8cea4a9c \
  https://releases.hashicorp.com/packer/1.9.5/packer_1.9.5_linux_amd64.zip \
  /tmp/packer.zip
RUN \
  export DEBIAN_FRONTEND=noninteractive && \
  apt-get -y update && \
  apt-get -y upgrade && \
  apt-get -y --no-install-recommends install \
    ca-certificates \
    curl \
    podman \
    python3 \
    unzip \
    qemu-system \
    qemu-utils \
    colorized-logs \
    expect \
    && \
  echo "deb [signed-by=/usr/share/keyrings/cloud.google.asc] http://packages.cloud.google.com/apt cloud-sdk main" > \
    /etc/apt/sources.list.d/google-cloud-sdk.list && \
  curl \
    -fs \
    -o /usr/share/keyrings/cloud.google.asc \
    https://packages.cloud.google.com/apt/doc/apt-key.gpg && \
  apt-get update -y && \
  apt-get install --no-install-recommends -y \
    google-cloud-sdk \
    && \
  unzip /tmp/packer.zip -d /usr/local/bin/ && \
  rm /tmp/packer.zip && \
  chmod +x /usr/local/bin/packer && \
  # Install required Packer plugins to fix 'Bundled plugins used' warnings
  packer plugins install github.com/hashicorp/googlecompute && \
  packer plugins install github.com/hashicorp/qemu && \
  apt-get clean && rm -rf /var/lib/apt/lists/*
