{
    "builders": [
        {
            "name": "pg-aio-bullseye",
            "type": "googlecompute",
            "project_id": "pg-vm-images-aio",
            "source_image_family": "debian-10",
            "source_image_project_id": "debian-cloud",
            "image_name": "pg-aio-bullseye-{{user `image_date`}}",
            "image_family": "pg-aio-bullseye",
            "ssh_username": "root",
            "ssh_pty": "true",
            "zone": "us-west1-a",
            "machine_type" : "e2-highcpu-4",
            "preemptible": "true",
            "disk_type" : "pd-ssd",
            "disk_size" : "10"
        },

        {
            "name": "pg-aio-sid",
            "type": "googlecompute",
            "project_id": "pg-vm-images-aio",
            "source_image_family": "debian-10",
            "source_image_project_id": "debian-cloud",
            "image_name": "pg-aio-sid-{{user `image_date`}}",
            "image_family": "pg-aio-sid",
            "ssh_username": "root",
            "ssh_pty": "true",
            "zone": "us-west1-a",
            "machine_type" : "e2-highcpu-4",
            "preemptible": "true",
            "disk_type" : "pd-ssd",
            "disk_size" : "10"
        },

        {
            "name": "pg-aio-sid-newkernel",
            "type": "googlecompute",
            "project_id": "pg-vm-images-aio",
            "source_image_family": "debian-10",
            "source_image_project_id": "debian-cloud",
            "image_name": "pg-aio-sid-newkernel-{{user `image_date`}}",
            "image_family": "pg-aio-sid-newkernel",
            "ssh_username": "root",
            "ssh_pty": "true",
            "zone": "us-west2-a",
            "machine_type" : "c2-standard-8",
            "preemptible": "true",
            "disk_type" : "pd-ssd",
            "disk_size" : "15"
        },


        {
            "name": "pg-aio-freebsd-12-2",
            "type": "googlecompute",
            "project_id": "pg-vm-images-aio",
            "source_image_family": "freebsd-12-2",
            "source_image_project_id": "freebsd-org-cloud-dev",
            "image_name": "pg-aio-freebsd-12-2-{{user `image_date`}}",
            "image_family": "pg-aio-freebsd-12-2",
            "ssh_username": "pg-vm-images-aio",
            "ssh_pty": "true",
            "zone": "us-west1-a",
            "machine_type" : "e2-highcpu-4",
            "preemptible": "true",
            "disk_type" : "pd-ssd",
            "disk_size": "23"
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "rm -f /etc/apt/sources.list.d/google-cloud.list /etc/apt/sources.list.d/gce_sdk.list",
                "DEBIAN_FRONTEND=noninteractive apt-get purge man-db google-cloud-sdk unattended-upgrades gnupg shim-unsigned publicsuffix mokutil -y",
                "DEBIAN_FRONTEND=noninteractive apt-get install -y grub-efi-amd64-bin",
                "DEBIAN_FRONTEND=noninteractive apt-get autoremove -y"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "echo 'deb http://deb.debian.org/debian unstable main' > /etc/apt/sources.list",
                "echo 'deb-src http://deb.debian.org/debian unstable main' >> /etc/apt/sources.list",
                "apt-get update -y"
            ],
            "only" : ["pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "echo 'deb http://deb.debian.org/debian bullseye main' > /etc/apt/sources.list",
                "echo 'deb-src http://deb.debian.org/debian bullseye main' >> /etc/apt/sources.list",
                "apt-get update -y"
            ],
            "only" : ["pg-aio-bullseye"]
        },

        {
            "type": "shell",
            "inline": [
                "apt-get update -y",
                "DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade --no-install-recommends -y"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "expect_disconnect" : true,
            "inline": [
                "shutdown -r now"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "DEBIAN_FRONTEND=noninteractive apt-get purge $(dpkg -l|grep linux-image|grep 4.19 |awk '{print $2}') -y",
                "sed -i 's/MODULES=most/MODULES=dep/' /etc/initramfs-tools/initramfs.conf",
                "update-initramfs -u -k all"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git build-essential gcc g++ libreadline-dev flex bison make perl libipc-run-perl clang llvm-dev libperl-dev libpython3-dev tcl-dev libldap2-dev libicu-dev docbook-xml docbook-xsl fop libxml2-utils xsltproc krb5-admin-server krb5-kdc krb5-user slapd ldap-utils libssl-dev pkg-config locales-all liburing-dev python3-distutils ccache gdb"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "DEBIAN_FRONTEND=noninteractive apt-get install -y time libelf-dev bc htop libdw-dev libdwarf-dev libunwind-dev libslang2-dev libzstd-dev binutils-dev  libnuma-dev libcap-dev libiberty-dev  libbabeltrace-dev systemtap-sdt-dev",
                "cd /usr/src/",
                "git clone --single-branch --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git",
                "cd linux",
                "make x86_64_defconfig",
                "make kvm_guest.config",
                "./scripts/config -e CONFIG_KVM_CLOCK",
                "./scripts/config -e CONFIG_LOCALVERSION_AUTO",
                "make mod2yesconfig",
                "time make -j16 -s all",
                "make -j16 -s modules_install",
                "make -j16 -s install",
                "cd tools/perf",
                "make install prefix=/usr/local/",
                "",
                "# build liburing",
                "apt purge liburing1",
                "cd /usr/src/",
                "git clone --single-branch --depth 1 https://github.com/axboe/liburing.git",
                "cd liburing/",
                "./configure --prefix=/usr/local/",
                "make -j8 -s install"
            ],
            "only" : ["pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "DEBIAN_FRONTEND=noninteractive apt-get autoremove -y",
                "apt-get clean",
                "rm -f /var/lib/apt/lists/deb.debian.org_*",
                "fstrim -v -a"
            ],
            "only" : ["pg-aio-bullseye", "pg-aio-sid", "pg-aio-sid-newkernel"]
        },

        {
            "type": "shell",
            "inline": [
                "sudo freebsd-update fetch install",
                "#sudo pkg remove -y google-cloud-sdk firstboot-freebsd-update firstboot-pkgs",
                "sudo pkg update",
                "sudo pkg upgrade -y",
                "sudo pkg install -y readline flex bison gmake perl5 p5-IPC-Run ccache",
                "sudo pkg clean -y",
                "# the following probably are a bad idea ",
                "#cp /etc/rc.conf /tmp/rc.conf",
                "#grep -v firstboot_ /tmp/rc.conf | sudo tee /etc/rc.conf",
                "sudo rm -fr /usr/ports /usr/src",
                "# this is needed to trigger growing the root filesystem on boot",
                "sudo touch /root/firstboot /firstboot"
            ],
            "only" : ["pg-aio-freebsd-12-2"]
        }
    ]
}
